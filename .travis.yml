language: cpp
os: linux
dist: bionic
sudo: false

branches:
  only:
  - master
  - develop

env:
  global:
    # Boost
    - BOOST_DIR=/usr/include
    - BOOST_LIBRARYDIR=/usr/lib/x86_64-linux-gnu
    # CMake
    - CMAKE_OPTIONS+=" -DBOOST_ROOT=${BOOST_DIR} -DBOOST_LIBRARYDIR=${BOOST_LIBRARYDIR}"
    
matrix:
  include:
    - compiler: gcc
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - g++-9
      env:
        - MATRIX_EVAL="CXX=g++ VER=9"

    - compiler: clang
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
            - llvm-toolchain-bionic-8
          packages:
            - clang-8
            - libstdc++-8-dev
      env:
        - MATRIX_EVAL="CXX=clang++ VER=8"

before_install:
  - eval "${MATRIX_EVAL}"
  - if [ "$CXX" == "g++" ]; then ln -s /usr/bin/gcc-${VER} /usr/local/bin/gcc && /usr/bin/g++-${VER} /usr/local/bin/g++; fi
  - if [ "$CXX" == "clang" ]; then ln -s /usr/bin/clang-${VER} /usr/local/bin/clang && export /usr/bin/clang++-${VER} /usr/local/bin/clang++; fi
  - pip install --user cpp-coveralls
  
install:
  ############################################################################
  # All the dependencies are installed in ${TRAVIS_BUILD_DIR}/deps/
  ############################################################################
  - DEPS_DIR="${TRAVIS_BUILD_DIR}/deps"
  - mkdir -p ${DEPS_DIR} && cd ${DEPS_DIR}

  ############################################################################
  # Install a recent CMake
  ############################################################################
  - sudo wget --no-check-certificate -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | sudo apt-key add -
  - sudo add-apt-repository 'deb https://apt.kitware.com/ubuntu/ bionic main'
  - sudo apt-get update
  - sudo apt -y install cmake
  - cmake --version

before_script:
  - sudo apt-get update -qq
  - sudo apt-get install libboost-thread-dev libboost-system-dev libboost-test-dev
  - cd ${TRAVIS_BUILD_DIR}

script:
  - mkdir _builds
  - cd _builds
  - cmake --version
  - cmake -DVIA_HTTPLIB_UNIT_TESTS=ON -DVIA_HTTPLIB_COVERAGE=ON ${CMAKE_OPTIONS} .. 
  - make
  - ./via-httplib_test

after_success:
  - cd ${TRAVIS_BUILD_DIR}
  - coveralls --root . -e build/CMakeFiles -E "test_*.o" --gcov-options '\-lp'
  
notifications:
  email:
    recipients:
      - ken.barker@via-technology.aero
    on_success: change
    on_failure: always
    